
<div id="ont_fc_table_div">
    <h1>
        <span id="ont_page_title">ONT flowcells</span>
    </h1>

    <table class="table table-striped table-bordered sortable" id="ont_fc_table">

        <thead style="vertical-align: top; white-space: nowrap">
            <tr class="sticky darkth">
                <th class="sort" data-sort="run_name">
                    <abbr data-toggle="tooltip" data-html="true" title="Follows format yymmdd_HHMM_position_flowcell_randomHash">
                        Run Name
                    </abbr>
                </th>
                <th class="sort" data-sort="library">
                    <abbr data-toggle="tooltip" data-html="true" title="Name of the sequenced sample or pool in LIMS">
                        Library
                    </abbr>
                </th>
                <th class="sort" data-sort="lims_step">
                    <abbr data-toggle="tooltip" data-html="true" title="ID of the LIMS step detailing the start of the sequencing run">
                        LIMS step
                    </abbr>
                </th>
                <th class="sort" data-sort="project">Project</th>
                <th class="sort" data-sort="prep_kit">Prep Kit</th>
                <th class="sort text-center" data-sort="flow_cell_qc">
                    <abbr data-toggle="tooltip" data-html="true" title="If a flowcell QC was performed prior to starting the run, its result is shown here.">
                        Prior QC
                    </abbr>
                </th>
                <th class="sort text-center" data-sort="load_fmol">Loading (fmol)</th>
                <th class="sort text-center" data-sort="basecalled_pass_bases_Gbp">Yield Passed (Gbp)</th>
                <th class="sort text-center" data-sort="basecalled_pass_read_count_M">Read Count Passed (M)</th>
                <th class="sort text-center" data-sort="n50_Kbp">N50 Passed (Kbp)</th>
                <th class="sort" data-sort="latest_running_note">Latest running note</th>
            </tr>
        </thead>
        <tfoot>
            <tr class="darkth">
                <th class="sort searchable" data-sort="run_name">Run name</th>
                <th class="sort searchable" data-sort="library">Library</th>
                <th class="sort searchable" data-sort="lims_step">LIMS step</th>
                <th class="sort searchable" data-sort="project">Project</th>
                <th class="sort searchable" data-sort="prep_kit">Prep Kit</th>
                <th class="sort" data-sort="flow_cell_qc"></th>
                <th class="sort" data-sort="load_fmol"></th>
                <th class="sort" data-sort="basecalled_pass_bases_Gbp"></th>
                <th class="sort" data-sort="basecalled_pass_read_count_M"></th>
                <th class="sort" data-sort="n50_Kbp"></th>
                <th class="sort" data-sort="latest_running_note"></th>
            </tr>
        </tfoot>

        <tbody class="list" style="vertical-align: top; width: 1%; white-space: nowrap">
            {% for onefc in ont_flowcells %}
                <tr>
                    <td>
                        <a class="text-decoration-none" href="/flowcells_ont/{{ onefc }}" target="_blank">{{ onefc }}</a>
                        {% if ont_flowcells.get(onefc).get('TACA_run_status') == 'finished' %}
                            <abbr title="Run completed"><span class="fa fa-check-circle"></span></abbr>
                        {% elif ont_flowcells.get(onefc).get('TACA_run_status') == 'ongoing' %}
                            <abbr title="Ongoing"><span class="fa fa-hourglass-half"></span></abbr>
                        {% elif ont_flowcells.get(onefc).get('TACA_run_status') == 'interrupted' %}
                            <abbr title="Run interrupted"><span class="fa fa-file-dashed-line"></span></abbr>
                        {% end %}
                    </td>
                    <td>
                        {% if ont_flowcells[onefc].get('library_id') %}
                            <a class="text-decoration-none" href="
                            https://ngi-lims-
                            {% if gs_globals['prod'] %}
                                prod
                            {% else %}
                                stage
                            {% end %}
                            .scilifelab.se/clarity/search?scope=Sample&query=
                            {{ ont_flowcells[onefc].get('library_id') }}
                            " target="_blank">
                            {{ ont_flowcells[onefc].get("library_name","") }}
                            </a>
                        {% else %}
                            {{ ont_flowcells[onefc].get("library_name","") }}
                        {% end %}
                    </td>
                    <td>
                        {% if ont_flowcells[onefc].get('step_id') %}
                            <a class="text-decoration-none" href="
                            https://ngi-lims-
                            {% if gs_globals['prod'] %}
                                prod
                            {% else %}
                                stage
                            {% end %}
                            .scilifelab.se/clarity/work/
                            {{ ont_flowcells[onefc]['step_id'][3:] }}
                            " target="_blank">
                            {{ ont_flowcells[onefc].get("step_id","") }}
                            </a>
                        {% else %}
                            {{ ont_flowcells[onefc].get("step_id","") }}
                        {% end %}
                    </td>
                    <td>
                        {% if ont_flowcells[onefc].get('projects') %}
                            {% for project_id, project_name in ont_flowcells[onefc]['projects'].items() %}
                                <samp style="max-width:50px;">
                                    <a class="text-decoration-none" href="/project/{{ project_id }}" target="_blank">{{ project_name }}</a>
                                </samp><br>
                            {% end %}
                        {% end %}
                    </td>
                    <td>{{ ont_flowcells[onefc].get("prep_kit","") }}</td>
                    <td class="text-center">
                        {{ ont_flowcells[onefc].get("qc","") }}
                    </td>

                    <td class="text-center">
                        {% try %}
                            {{ ont_flowcells[onefc]["lims"]["loading"][-1]["load_fmol"] }} 
                        {% except %}
                            {{ "" }}
                        {% end %}
                    </td>

                    <td class="text-center">
                        {{ ont_flowcells[onefc].get("basecalled_pass_bases_Gbp", "") }}
                    </td>
                    <td class="text-center">{{ ont_flowcells[onefc].get("basecalled_pass_read_count_M", "") }}</td>
                    <td class="text-center">
                        {{ ont_flowcells[onefc].get("n50_Kbp", "") }}
                    </td>
                    <td style="width: 100%" class="latest_running_note">
                        {% if ont_flowcells[onefc].get('latest_running_note') %}
                            {% set running_notes = ont_flowcells[onefc].get('latest_running_note') %}
                            {% set latest_running_note_key = list(running_notes.keys())[0] %}
                            <div class="card running-note-card">
                                <div class='card-header'>
                                <a class="text-decoration-none" href='mailto:{{ running_notes[latest_running_note_key]["email"].encode("ascii","ignore")}}'>{{ running_notes[latest_running_note_key]["user"]}}</a>  -  {{form_date(latest_running_note_key)}}
                                {% if running_notes[latest_running_note_key]['categories'] %} - <span class="fillbadgecolour"> {{ running_notes[latest_running_note_key]['categories'] }} </span> {% end %}
                                </div>
                                <div class='card-body trunc-note-latest' style='white-space: pre-line'>
                                    {{running_notes[latest_running_note_key]['note']}}
                                </div>
                            </div>
                        {% end %}
                    </td>
                </tr>
            {% end %}
        </tbody>
    </table>
</div>

 <!-- ONT Table Sorting -->
<script type="text/javascript">
$( document ).ready(function() {
  var table = init_listjs_ont();
  initColumnSearch(table);
  table.on('column-reorder', function (e, settings, details) {
     let footer = $('#ont_fc_table tfoot tr');
     let inputs = footer.find('input').detach(); // Detach all inputs
     // Clear footer
     footer.empty();
     // Rebuild footer row based on new column order
    const tab = new $.fn.dataTable.Api(settings);
    tab.columns().every(function (i) {
         let th = $('<th></th>');
         let input = $(inputs[details.mapping[i]] || $('<input type="text" />')); // Preserve existing input if possible
         let headertext =$(tab.column(i).header()).text();
         input.attr('placeholder', `Search ${headertext}`);
         th.append(input);
         footer.append(th);
     });
     initColumnSearch(tab); // Re-bind search
    });
});
// Initialize sorting and searching javascript plugin
function init_listjs_ont() {
    // Setup - add a text input to each footer cell
    $('#ont_fc_table tfoot th.searchable').each( function () {
      var title = $('#ont_fc_table thead th').eq( $(this).index() ).text();
      $(this).html( '<input size=10 type="text" placeholder="Search '+title+'" />' );
    } );

    var table = $('#ont_fc_table').DataTable({
        "paging":false,
        "info":false,
        "order": [[ 0, "desc" ]],
        dom: 'Bfrti',
        colReorder: true,
        buttons: [
        {
            extend: 'copy',
            className: 'btn btn-outline-dark mb-3',
            messageTop: null,
            title: null,
        },
        {
            extend: 'excel',
            className: 'btn btn-outline-dark mb-3',
            messageTop: null,
            title: null,
        }
      ]
    });

    //Add the bootstrap classes to the search thingy

    $('div.dataTables_filter input').addClass('form-control search search-query');
    $('#ont_fc_table_filter').addClass('form-inline float-right pt-1');
    $("#ont_fc_table_filter").appendTo($('#ont_page_title'));
    $('#ont_fc_table_filter label input').appendTo($('#ont_fc_table_filter'));
    $('#ont_fc_table_filter label').remove();
    $("#ont_fc_table_filter input").attr("placeholder", "Search..");

    return table;
}

function initColumnSearch(table) {
    table.columns().every( function () {
        var that = this;
        $( 'input', this.footer() ).on( 'keyup change', function () {
            that
            .search( this.value )
            .draw();
        } );
    } );
}
</script>