{% extends "base.html" %}

<!-- Example row of columns -->
{% block stuff %}

<div class="container-fluid">
  <h2>Projects</h2>
  <p> You can search for anything in the table and sort on any column by clicking on the column header. </p>
  <div id="project-list">
    <form id="Filter" class="form form-search">
      <fieldset>
	<div class="control-group">
	  <input class="search search-query" type="text" placeholder="Search..." />
	</div>
	<div>
	  <button id="Reset" class="btn btn-large"> Reset </button>
	</div>
	<div>
	  <input type="submit" value="Apply Filter" class="btn btn-primary btn-large" id="applyFilter">
	</div>
	<div class="control-group">
	  {% for col_display_name, col_name in columns.iteritems() %}
	    <input type="checkbox" name={{col_name}} id={{col_name}}>
	    <label for={{col_name}}>
		{{col_display_name}}
              </label>
            </input>
	  {% end %}
	</div>
      </fieldset>
    </form>
    <table class="table" id="project_table">
      <thead id="project_table_head">
      </thead>
      <tbody class="list" id="project_table_body">
      </tbody>
    </table>
  </div>
</div>

<script>
/* check default checkboxes */
reset_default_checkboxes();
load_table();

/* Reset button handled here */
$("#Reset").click(function( event ) {
  event.preventDefault();
  reset_default_checkboxes();
  load_table();
});

/* Apply filter button handled here */
$("#applyFilter").click( function( event ) {
  event.preventDefault();
  load_table();
});

function reset_default_checkboxes(){
  $("#Filter :checkbox").attr('checked', true)
}

function read_current_filtering(){
  var columns = new Array();
  $("#Filter :checkbox:checked").each(function() {
    columns.push([$(this).next('label').text(), $(this).attr('name')]);
  });
  return columns
}

function load_table_head(columns){
  var tbl_head = '<tr class="a" onmouseover="this.style.cursor="pointer"">'
  $.each(columns, function(i, column_tuple) {
    tbl_head += '<th class="sort" data-sort="' + column_tuple[1] + '">' + column_tuple[0] + '</th>'
  });
  tbl_head += '</tr>'
  $("#project_table_head").html(tbl_head)
}


function load_table(){
  columns = read_current_filtering();
  load_table_head(columns)
  /* Project column is treated as special case, since it is a link */
  var project_column = $("#Filter :checkbox[name='project']").is(":checked")
  $.getJSON("/api/v1/projects", function(data) {
    var tbl_body = "";
    var size = 0;
    $.each(data, function(key, summary) {
      size++;
      tbl_row = '<tr project_column=' + project_column + '>'
      if(project_column){
        tbl_row += '<td><a class="project" href="/projects/' + key + '">' + key  + '</td>'
      }
      $.each(columns, function(i, column_tuple){
        if(column_tuple[1]!="project"){
          tbl_row += '<td class="' + column_tuple[1] + '">' + summary[column_tuple[1]] + '</td>'
        }
      })
      tbl_row += '</tr>'
      tbl_body += tbl_row
    })
    $("#project_table_body").html(tbl_body)
    init_listjs(size, columns)
  })
}


// Initialize sorting and searching javascript plugin
function init_listjs(no_items, columns) {
    column_names = new Array();
    $.each(columns, function(i, column_tuple){
      column_names.push(column_tuple[1])
    })
    var options = {
        valueNames: column_names,
        page: no_items /* Default is to show only 200 items at a time. */
    };

    var featureList = new List('project-list', options);
}

</script>

{% end %}
