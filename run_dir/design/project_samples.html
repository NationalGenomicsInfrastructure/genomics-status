{% extends "base.html" %}

<!-- Example row of columns -->
{% block stuff %}

<div class="row-fluid">
  <h3 name="project_name" id="project_name"></h3>
  <div name="project_status"></div>
  <!--Order dates table -->
  <table class="table table-bordered table-condensed">
    <thead>
      <tr>
        <th class="span2">Order Received</th>
        <th class="span2">Contract Sent</th>
        <th class="span2">Plates Sent</th>
        <th class="span2">Contract Received</th>
        <th class="span2">Sample Information Received</th>
        <th class="span2">Samples Received</th>
      </tr>
    </thead>
    <tbody>
    <tr>
      <td name='{{columns['SETUP_PROJECT_COLUMNS']['Order Received']}}'></td>
      <td name='{{columns['SETUP_PROJECT_COLUMNS']['Contract Sent']}}'></td>
      <td name='{{columns['SETUP_PROJECT_COLUMNS']['Plates Sent']}}'></td>
      <td name='{{columns['SETUP_PROJECT_COLUMNS']['Contract Received']}}'></td>
      <td name='{{columns['SETUP_PROJECT_COLUMNS']['Sample Information Received']}}'></td>
      <td name='{{columns['SETUP_PROJECT_COLUMNS']['Samples Received']}}'></td>
    </tr>
    </tbody>
  </table>
  <!-- Protect timeline -->
  <table class="table table-bordered table-condensed">
    <thead>
      <tr>
        <th class="span1">Days in Production</th>
        <th class="span1">Open date</th>
        <th class="span1">First Initial QC Start Date</th>
        <th class="span1">Queue Date</th>
        <th class="span1">Library Prep Start</th>
        <th class="span1">QC Library Finished</th>
        <th class="span1">Sequencing Start</th>
        <th class="span1">All Samples Sequenced</th>
        <th class="span1">All Raw Data Delivered</th>
        <th class="span1">Best Practice Analysis Completed</th>
        <th class="span1">Close Date</th>
        <th class="span1">Aborted</th>
      </tr>
    </thead>
    <tbody>
    <tr>
      <td name='{{columns['BASIC_COLUMNS']['Days in Production']}}'></td>
      <td name='{{columns['BASIC_COLUMNS']['Open Date']}}'></td>
      <td name='{{columns['EXTRA_COLUMNS']['First Initial QC Start Date']}}'></td>
      <td><div name='{{columns['BASIC_COLUMNS']['Queue Date']}}'></div>
        <div name='signature_queued'></div></td>
      <td name='{{columns['LIBRARY_PREP_COLUMNS']['Library Prep Start']}}'></td>
      <td name='{{columns['LIBRARY_PREP_COLUMNS']['QC Library Finished']}}'></td>
      <td name='{{columns['SEQUENCING_COLUMNS']['Sequencing Start']}}'></td>
      <td><div name='{{columns['DETAILS_COLUMNS']['All Samples Sequenced']}}'></div>
        <div name='signature_all_samples_sequenced'></div></td>
      <td><div name='{{columns['BIOINFO_COLUMNS']['All Raw Data Delivered']}}'></div>
        <div name='signature_all_raw_data_delivered'></div></td>
      <td><div name='{{columns['BIOINFO_COLUMNS']['Best Practice Analysis Completed']}}'></div>
        <div name='signature_best_practice_analysis_completed'></div></td>
      <td name='{{columns['DETAILS_COLUMNS']['Close Date']}}'></td>
      <td name='{{columns['DETAILS_COLUMNS']['Aborted']}}'></td>
    </tr>
    </tbody>
  </table>
</div>

<div class="row-fluid">
  <!-- Project comment -->
  <div class="span12">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Project Comment</th>
        </tr>
      </thead>
      <tbody>
      <tr>
        <td>
          <p name="project_comment"></p>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Tab Details - Communication -->
<div class="tabbable">
  <ul class="nav nav-tabs">
    <li class="active"><a href="#tab_details_content" id="tab_details" data-toggle="tab">Project information</a></li>
    <li><a href="#tab_com_content" id="tab_communication" data-toggle="tab" style="display: none;">User communication</a></li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane active" id="tab_details_content">
      <div class="accordion" id="accordion">
        <div class="accordion-group">
          <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" href="#collapseOne">
              Project details
            </a>
          </div>
          <div id="collapseOne" class="accordion-body collapse">
            <div class="accordion-inner">
              <div class="row-fluid">
                <div class="span4">
                  <!--Order Info Table-->
                  <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>Order info</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td>Type</td>
                      <td name='{{columns['BASIC_COLUMNS']['Type']}}'></td>
                    </tr>
                    <tr>
                      <td>Application</td>
                      <td name='{{columns['BASIC_COLUMNS']['Application']}}'>Application</td>
                    </tr>
                    <tr>
                      <td>Disposal Of Samples</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Disposal of Samples']}}'></td>
                    </tr>
                    </tbody>
                  </table>

                  <!-- Responsables and Contacts table -->
                  <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>Responsibles and contacts</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td>Bioinfo. Responsible</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Bioinfo. Responsible']}}'></td>
                    </tr>
                    <tr>
                      <td>Lab Responsible</td>
                      <td name='{{columns['SETUP_PROJECT_COLUMNS']['Lab. Responsible']}}'></td>
                    </tr>
                    <tr>
                      <td>Project Coordinator</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Project Coordinator']}}'></td>
                    </tr>
                    <tr>
                      <td>Contact</td>
                      <td name='{{columns['DETAILS_COLUMNS']['PI']}}'></td>
                    </tr>
                    <tr>
                      <td>Invoice Reference</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Invoice Reference']}}'></td>
                    </tr>
                    </tbody>
                  </table>
                </div>

                <!--Bioinformatics Info Table-->
                <div class="span4">
                  <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>Bioinformatics</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td>Uppnex ID</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Uppnex ID']}}'></td>
                    </tr>
                    <tr>
                      <td>Source</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Source']}}'></td>
                    </tr>
                    <tr>
                      <td>Custom capture design</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Custom Capture Design']}}'></td>
                    </tr>
                    <tr>
                      <td>UPPMAX project owner</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Uppmax Project Owner']}}'></td>
                    </tr>
                    <tr>
                      <td>Best Practice Bioinformatics</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Best Practice Bioinformatics']}}'></td>
                    </tr>
                    <tr>
                      <td>Bioinfo Analysis</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Bioinformatic QC']}}'></td>
                    </tr>
                    <tr>
                      <td>Organism</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Organism']}}'></td>
                    </tr>
                    <tr>
                      <td>Reference Genome</td>
                      <td name='{{columns['BIOINFO_COLUMNS']['Reference Genome']}}'></td>
                    </tr>
                    </tbody>
                  </table>
                </div>
                <!-- Wet Lab table -->
                <div class="span4">
                  <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>Wet Lab</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td>Sample type</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Sample Type']}}'></td>
                    </tr>
                    <tr>
                      <td>Sequencing Platform</td>
                      <td name='{{columns['SEQUENCING_COLUMNS']['Sequencing Platform']}}'></td>
                    </tr>
                    <tr>
                      <td>Sequencing Setup</td>
                      <td name='{{columns['SEQUENCING_COLUMNS']['Sequencing Setup']}}'></td>
                    </tr>
                    <tr>
                      <td>Library Construction Method</td>
                      <td name='{{columns['LIBRARY_PREP_COLUMNS']['Library Construction Method']}}'></td>
                    </tr>
                    <tr>
                      <td>%phiX</td>
                      <td name='{{columns['DETAILS_COLUMNS']['%phiX']}}'></td>
                    </tr>
                    <tr>
                      <td>Low Diversity</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Low Diversity']}}'></td>
                    </tr>
                    <tr>
                      <td>Custom Primer</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Custom Primer']}}'></td>
                    </tr>
                    <tr>
                      <td>Lanes Ordered</td>
                      <td name="{{columns['DETAILS_COLUMNS']['Lanes']}}"></td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="row-fluid">
                <!-- Samples table -->
                <div class="span4">
                  <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>Samples</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td>Final samples</td>
                      <td name='{{columns['DETAILS_COLUMNS']['Final Number of Samples']}}'></td>
                    </tr>
                    <tr>
                      <td>Samples</td>
                      <td name='{{columns['BASIC_COLUMNS']['Number of Samples']}}'></td>
                    </tr>
                    <tr>
                      <td>Completed Samples</td>
                      <td name='{{columns['BASIC_COLUMNS']['Samples Completed']}}'></td>
                    </tr>
                    <tr>
                      <td>Pools</td>
                      <td name ='number_of_pools'></td>
                    </tr>
                    </tbody>
                  </table>
                </div>
                <!-- Sample status table -->
                <div class="span4">
                  <table class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>Sample Status</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td>Finished</td>
                      <td name='Finished'></td>
                    </tr>
                    <tr>
                      <td>In progress</td>
                      <td name='In Progress'></td>
                      <tr>
                        <td>Aborted</td>
                        <td name='Aborted'></td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                  <!-- Progress summary table -->
                  <div class="span4">
                    <table class="table table-bordered table-striped">
                      <thead>
                        <tr>
                          <th>Progress summary</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                      <tr>
                        <td>Incoming QC</td>
                        <td name='passed_initial_qc'></td>
                      </tr>
                      <tr>
                        <td>Library QC</td>
                        <td name='passed_library_qc'></td>
                        <tr>
                          <td>Sequencing QC</td>
                          <td name='passed_seq_qc'></td>
                        </tr>
                        <tr>
                          <td>Library re-preps</td>
                          <td name='library_repreps'></td>
                        </tr>
                        <tr>
                          <td>Lanes started</td>
                          <td name="lanes_sequenced"></td>
                        </tr>
                        <tr>
                          <td>Sequencing re-runs</td>
                          <td></td>
                        </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="row-fluid">
                    <!-- User project description -->
                    <div class="span6">
                      <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th>User project description</th>
                          </tr>
                        </thead>
                        <tbody>
                        <tr>
                          <td >
                            <div class="alert">
                              <button type="button" class="close" data-dismiss="alert">&times;</button>
                              <strong>Warning!</strong> Note that this is the original user description of the project and may not reflect the final order. Use with caution!
                            </div>
                            <p name="customer_project_description"></p>
                          </td>
                        </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- Project summary comment -->
                    <div class="span6">
                      <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th>Project Summary Comment</th>
                          </tr>
                        </thead>
                        <tbody>
                        <tr>
                          <td >
                            <p name="comment"></p>
                          </td>
                        </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>             

                  <div class="row-fluid">
                    <!-- Undefined fields -->
                    <div class="span12">
                      <div class="accordion" id="accordion2">
                        <div class="accordion-group">
                          <div class="accordion-heading">
                            <a class="accordion-toggle" data-toggle="collapse" href="#collapseUndefinedFields">
                              Undefined Fields
                            </a>
                          </div>
                          <div id="collapseUndefinedFields" class="accordion-body collapse">
                            <div class="accordion-inner">
                              <!-- Undefined Fields Table -->
                              <table class="table table-condensed table-hover">
                                <tbody id="undefined_project_info">
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#collapseThree">
                  Project Samples
                </a>
              </div>
              <div id="collapseThree" class="accordion-body collapse">
                <div class="accordion-inner" id="sample-list">
                <div class="tabbable tabs-left">
                  <ul class="nav nav-tabs">
                    <li class="active"><a href="#Search-tab" data-toggle="tab">Search</a></li>
                    <li><a href="#Filter-tab" data-toggle="tab">Choose Columns</a></li>
                  </ul>
                  <div class="tab-content">
                    <div class="tab-pane active" id="Search-tab">
                      <form id="Search-form">
                        <legend>Search Table Contents</legend>
                        <input class="search search-query" type="text" placeholder="Search..." id="search_field"/>
                      </form>
                    </div>
                    <div class="tab-pane" id="Filter-tab">
                      <form id="Filter" class="form form-search">
                        <legend>Choose Columns</legend>
                        <div class="btn-group">
                          <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                            Default presets
                            <span class="caret"></span>
                          </a>
                          <ul class="dropdown-menu" id="default_presets_dropdown">
                            <!-- Load default presets (to be filled with JS) -->
                          </ul>
                        </div>
                        <div class="row-fluid">
                          <div class='span9'>
                          <div class="span3">
                            <div  id="basic-columns">
                              <h3 class="clickable_header"> Basic </h3>
                              {% for col_display_name, col_name in columns_sample['BASIC_COLUMNS'].iteritems() %}
                              <input type="checkbox" name="{{col_name}}" id="{{col_name}}">
                              <label for="{{col_name}}">
                                {{col_display_name}}
                              </label>
                              </input>
                              <br />
                              {% end %}
                            </div>
                            <div class="fieldset" id="details-columns">
                              <h3 class="clickable_header"> Sample Details </h3>
                              {% for col_display_name, col_name in columns_sample['DETAILS_COLUMNS'].iteritems() %}
                              <input type="checkbox" name="{{col_name}}" id="{{col_name}}">
                              <label for="{{col_name}}">
                                {{col_display_name}}
                              </label>
                              </input>
                              <br />
                              {% end %}
                            </div>
                          </div>
                          <div class="span3">
                            <div class="fieldset" id="initial-qc-columns">
                              <h3 class="clickable_header"> Initial QC </h3>
                              {% for col_display_name, col_name in columns_sample['INITIAL_QC_COLUMNS'].iteritems() %}
                              <input type="checkbox" name="{{col_name}}" id="{{col_name}}">
                              <label for={{col_name}}>
                                {{col_display_name}}
                              </label>
                              </input>
                              <br />
                              {% end %}
                            </div>
                          </div>
                          <div class="span3">
                            <div class="fieldset" id="library-prep-columns">
                              <h3 class="clickable_header"> Library Prep </h3>
                              {% for col_display_name, col_name in columns_sample['LIBRARY_PREP_COLUMNS'].iteritems() %}
                              <input type="checkbox" name="{{col_name}}" id="{{col_name}}">
                              <label for="{{col_name}}">
                                {{col_display_name}}
                              </label>
                              </input>
                              <br />
                              {% end %}
                            </div>
                          </div>
                          <div class="span3">
                            <div class="fieldset" id="library-validation-columns">
                              <h3 class="clickable_header"> Library Validation </h3>
                              {% for col_display_name, col_name in columns_sample['LIBRARY_VALIDATION_COLUMNS'].iteritems() %}
                              <input type="checkbox" name="{{col_name}}" id="{{col_name}}">
                              <label for={{col_name}}>
                                {{col_display_name}}
                              </label>
                              </input>
                              <br />
                              {% end %}
                            </div>
                          </div>
                        </div>
                        <div class='span3'>
                          <p>
                            <button id="Reset" class="btn btn-large"> Reset</button>
                            </p>
                            <p>
                            <input type="submit" value="Apply" class="btn btn-primary btn-large" id="applyFilter">
                            </p>
                        </div>
                        </div>
                      </form>
                      </div>
                    </div>
                  </div>
                  <p>
                  This lists all samples belonging to the project. Here 'reads sequenced'
                  refers to reads passing application QC criterions. If the sequence run is
                  paired end, 'reads' are actually read pairs.
                  </p>
                  <p>
                  If a sample is named 'Unexptectedbarcode' refers to reads which failed to
                  demultiplex.
                  </p>
                  <div class="scrollable">
                    <table class="table table-striped" id="sample_table">
                      <thead id="samples_table_head">
                      </thead>
                      <tbody class="list" id="samples_table_body">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#collapseFour">
                  Running Notes
                </a>
              </div>
              <div id="collapseFour" class="accordion-body collapse">
                <div class="accordion-inner">
                  <table class="table">
                    <tbody id="running_notes_table">
                    <!-- Table dynamically built with JS function load_running notes -->
                    </tbody>
                  </table>
                  <form action="" method="POST" id="running_notes_form">
                    <div class="form-actions">
                      <p>Insert new running note:</p>
                      <textarea rows="7" class="span12" id="new_note_text"></textarea>
                      <button type="submit" class="btn btn-primary" id="save_note_button">Save running note</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" href="#collapseFive">
                  Links
                </a>
              </div>
              <div id="collapseFive" class="accordion-body collapse">
                <div class="accordion-inner">
                  <table class="table">
                    <tbody id="links_table">
                    <!-- Dynamic content -->
                    </tbody>
                  </table>
                  <form role="form" id="link_form" class="form-horizontal">
                    <div id="new_link_alert"></div>
                    <div class="form-actions">
                      <div class="form-group">
                        <label for="new_link_type" class="control-label">Type</label><div class="span1"></div>
                        <select class="form-control" required id="new_link_type">
                          <option value=""></option>
                          <option>Deviation</option>
                          <option>Other</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="new_link_title" class="control-label">Title</label><div class="span1"></div>
                        <input type="text" required class="form-control span8" id="new_link_title" placeholder="14_01 example"/>
                      </div>
                      <div class="form-group">
                        <label for="new_link_url" class="control-label">URL</label><div class="span1"></div>
                        <input type="url" class="form-control span8" id="new_link_url" placeholder="https://docs.google.com/example"/>
                      </div>
                      <div class="form-group">
                        <label for="new_link_desc" class="control-label">Description</label><div class="span1"></div>
                        <textarea rows="4" class="form-control span8" id="new_link_desc" placeholder="Description text"></textarea>
                      </div>
                      <div class="form-group">
                        <label for="save_link_button" class="control-label"></label><div class="span1"></div>
                        <button type="submit" class="btn btn-primary" id="save_link_button">Add link</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <a href="" class="toggleCollapse plus">[+]</a>
          </div>
        </div>
        <div class="tab-pane" id="tab_com_content">
        </div>
      </div>
    </div>

<!-- Javascript -->

<script>

/* check default checkboxes */
if (!$("#Filter :checked").length) {
  reset_default_checkboxes();
}

var ordered_reads = 0.0

load_undefined_info();
load_all_udfs();
load_samples_table();
load_running_notes();
load_links();

// Searching functionality

//Prevent traditional html submit function
$('#Search-form').submit(function(event){event.preventDefault();});


// Initialize sorting and searching javascript plugin
function init_listjs(no_items, columns) {
  column_names = new Array();
  $.each(columns, function(i, column_tuple){
    column_names.push(column_tuple[1])
  })
  var options = {
    valueNames: column_names,
    page: no_items /* Default is to show only 200 items at a time. */
  };
  var featureList = new List('sample-list', options);
  featureList.search($('#search_field').val());
}

////////////////////////////////////
// Choose columns related methods //
////////////////////////////////////

/* Reset button handled here */
$("#Reset").click(function( event ) {
  event.preventDefault();
  reset_default_checkboxes();
});

/* Apply filter button handled here */
$("#applyFilter").click( function( event ) {
  event.preventDefault();
  load_samples_table();
});

function read_current_filtering(header){
  /* If header == True will return a dictionary representing exactly what the
     page shows. I.e columns['basic-columns'] = [['SciLife Sample Name', 'scilife_name'] ...]

     If header == False will return only an array of pairs [display_name, column_id]
  */
  if (header){
    var columns = new Object();
    $("#Filter :checkbox:checked").each(function() {
      var p = $(this).parent().attr('id');
      if (!columns.hasOwnProperty(p)) {
        columns[p] = new Array([$(this).next('label').text(), $(this).attr('name')]);
      }
      else {
        columns[p].push([$(this).next('label').text(), $(this).attr('name')]);
      }
    });
    return columns
  }
  else {
    var columns = new Array();
    $("#Filter :checkbox:checked").each(function() {
        columns.push([$(this).next('label').text(), $(this).attr('name')]);
        });
    return columns
  }
}

function reset_default_checkboxes(){
  {% for col_display_name, column_name in columns_sample['BASIC_COLUMNS'].iteritems() %}
  document.getElementById("{{column_name}}").checked = true;
  {% end %}
  {% for col_display_name, column_name in columns_sample['DETAILS_COLUMNS'].iteritems() %}
  document.getElementById("{{column_name}}").checked = false;
  {% end %}
  {% for col_display_name, column_name in columns_sample['INITIAL_QC_COLUMNS'].iteritems() %}
  document.getElementById("{{column_name}}").checked = false;
  {% end %}
  {% for col_display_name, column_name in columns_sample['LIBRARY_PREP_COLUMNS'].iteritems() %}
  document.getElementById("{{column_name}}").checked = false;
  {% end %}
  {% for col_display_name, column_name in columns_sample['LIBRARY_VALIDATION_COLUMNS'].iteritems() %}
  document.getElementById("{{column_name}}").checked = false;
  {% end %}

  $("#Filter #undefined_columns").children("input").attr('checked', false)
}
      
//Check or uncheck all fields from clicked category
function choose_column(col){
  var column = document.getElementById(col);
  //Get all the children (checkboxes)
  cbs = column.getElementsByTagName('input');
  //If one of them is checked we uncheck it, if none of them are checked, 
  //we check them all
  checked = false;
  for (var i = 0; i < cbs.length; i++) {
    if (cbs[i].checked) {
      cbs[i].checked = false;
      checked = true;
    }
  }
  if (!checked) {
    for (var i = 0; i < cbs.length; i++) {
      cbs[i].checked = true;
    }
  }
}

//For the clickable_header class, execute the choose_column func with the column ID
$(".clickable_header").click(function(event){ 
    choose_column($(this).parent().attr("id"))
  }
);


////////////////////////////////
// Presets related functions  //
///////////////////////////////

function load_presets() {
  $.getJSON('/api/v1/presets?presets_list=sv_presets', function (data) {
    var default_presets = data['default'];
    var user_presets = data['user'];

    //Empty previously filled lists of presets
    $('ul#default_presets_dropdown').empty();
    $('ul#user_presets_dropdown').empty();

    //Default presets
    for (var preset in default_presets) {
      var li = '<li class="clickable_dropdown" id="' + preset + '">';
      li += '<a tabindex="-1">' + preset + '</a></li>';
      $('ul#default_presets_dropdown').append(li);
    }
    //User presets, if there are any
    if (!jQuery.isEmptyObject(user_presets)) {
      for (var preset in user_presets) {
        var li = '<li class="clickable_dropdown" id="' + preset + '">';
        li += '<a tabindex="-1">' + preset + '</a></li>';
        $('ul#user_presets_dropdown').append(li);
      }
    }
    else {
      var li = '<li class="disabled"><a tabindex="-1">';
      li += 'No user presets';
      li += '</a></li>';
      $('ul#user_presets_dropdown').append(li);
    }

    //Execute function select_from_preset when clicking a clickable_dropdown
    $(".clickable_dropdown").click(function(event) {
        select_from_preset($(this).parent().attr('id'), $(this).attr('id'))
      }
    );
  });
}

//Fill in the presets at the beginning
load_presets();

function select_from_preset(preset_type, preset) {
  $.getJSON('/api/v1/presets?presets_list=sv_presets', function (data) {
    //First uncheck everything
    $('input:checkbox').removeAttr('checked');
    if (preset_type == "default_presets_dropdown") {
      var choices = data['default'][preset];
      for (column in choices) {
        for (choice in choices[column]) {
          document.getElementById(choice).checked = choices[column][choice];
        }
      }
    }
    else if (preset_type == "users_presets_dropdown") {
    }
  });
}

// Others

//Hide or show all accordions
$(document).on('click', '.toggleCollapse',function(e) {
  e.preventDefault();
  if ($(this).is('.plus')) {
    $(this).removeClass('plus'); $(this).text('[-]')
    $('.tab-pane.active').find('div.collapse').collapse('show')
  }
  else {
    $(this).addClass('plus'); $(this).text('[+]')
    $('.tab-pane.active').find('div.collapse').collapse('hide')
  }
});

function load_links() {
  var link_icon = {'Deviation':'icon-exclamation-sign', 'Other':'icon-file'}
  $("#links_table").empty()
  $.getJSON("/api/v1/links/{{ project }}", function(data) {
    $.each(data, function(key, link) {
      var date = new Date(key)
      var row = '<tr>'
      row += '<td class="span1"><span class="' + link_icon[link['type']] + '"></span></td>'
      row += '<td>' + '<a' +  (link['url'] === "" ? "" : (' href="' + link['url'] + '"')) + '>'+ link['title'] + '</a>'
      row += '<p class="small muted">Added by ' + '<a href="mailto:' + link['email'] + '">' + link['user'] + '</a> on ' + date.toDateString() + '</p><td>'
      row += '<td><pre>' + link['desc'] + '</pre></td>'
      row += '</tr>'
      $("#links_table").append(row);
    });
  });
}

$("#link_form").submit(function(e) {
  e.preventDefault();
  var type = $('#new_link_type option:selected').val()
  var title = $('#new_link_title').val()
  var url = $('#new_link_url').val()
  var desc = $('#new_link_desc').val()

  if (title && type) {
    $.ajax({
      async: false,
      type: 'POST',
      url: '/api/v1/links/{{ project }}',
      dataType: 'json',
      data: {'type': type, 'title': title, 'url':url, 'desc':desc},
    });
    //Clear form fields
    $('#new_link_type, #new_link_title, #new_link_url, #new_link_desc').val("")
    load_links();
  }
  else if(!$.browser.chrome) {
    //Non-chrome users might not get a useful html5 message
    alert('The link needs a title and a type needs to be selected')
  }
});

/* This will make that the tickets from ZenDesk are loaded ONLY under request
(the user clicking to the tab). Otherwise we don't want to query ZenDesk API if
not requested.
*/
$('#tab_communication').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
  load_tickets();
});

function load_tickets() {
  var tab_communication = document.getElementById('tab_com_content');
  if (tab_communication.children.length == 0) {
    fetching_data.showPleaseWait();
    var a_header = '<p><b>Note:</b> Internal notes are shown in a yellow box </p> \
                    <div class="accordion" id="tickets_accordion">';
    var a_group = ' \
    <div class="accordion-group"> \
      <div class="accordion-heading"> \
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#tickets_accordion" href="#c{num_ticket}"> \
        {thread_name} \
        </a> \
      </div> \
      <div id="c{num_ticket}" class="accordion-body collapse"> \
        <div class="accordion-inner"> \
          {thread_content} \
        </div> \
      </div> \
    </div>';
    //Get the project name from the header of the page
    var p_name = $("#project_name").attr('p_name');

    $.getJSON("/api/v1/project/{{ project }}/tickets?p_name=" + p_name, function(data){
      if ($.isEmptyObject(data)) {
        $('#tab_com_content').html("<h3>No tickets available for " + p_name + "</h3>");
      }
      else {
        // Build the accordion with the tickets information
        var accordion = a_header;
        var tickets = 1;
        // Javascript Object order is not guaranteed, but we want to show the most recent
        // issued ticket first
        $.each(Object.keys(data).reverse(), function(_, k) {
          var v = data[k];
          var title = "Ticket No. " + k + "<br />" + "Created at " + v['created_at'].split('T')[0] +
                      "<br /> " + v['subject'] + "." + "<br />" + "Status: " + v['status'];
          var comments = '<center><a href="https://ngisweden.zendesk.com/agent/#/tickets/' + k + '">View it on ZenDesk</a></center>';
          v['comments'].reverse();
          $.each(v['comments'], function(k, c){
            var updated_at = new Date(c['created_at']);
            comments += "Updated on " + updated_at.toGMTString();
            if (c['public']) {
              comments += '<pre>' + c['body'] + '</pre><hr />';
            }
            else {
              comments += '<div class="alert alert-warning">' + c['body'] + '</div>';
            }
          });
          accordion += a_group.replace(/{num_ticket}/g, tickets)
                              .replace(/{thread_name}/g, title)
                              .replace(/{thread_content}/g, comments);
          tickets++;
        });
        accordion += '<a href="" class="toggleCollapse plus">[+]</a>'
        $('#tab_com_content').html(accordion);
      }
      fetching_data.hidePleaseWait();
    });
  }
}

function load_running_notes(wait) {
  //Clear previously loaded notes, if so
  $("#running_notes_table").empty()
  $.getJSON("/api/v1/running_notes/{{ project }}", function(data) {
    $.each(data, function(date, note) {
      var date = new Date(date)
      var row = '<tr>'
      row += '<td>' + date.toDateString() + ', ' + date.toLocaleTimeString(date) + ' by '
      row += '<a href="mailto:' + note['email'] + '">' + note['user'] + '</a></td>'
      row += '<td><pre>' + note['note'] + '</pre></td>'
      row += '</tr>'
      $("#running_notes_table").append(row);
    });
  //Clear text area
  document.getElementById('new_note_text').value = '';
  });
}

// Insert new running note and reload the running notes table
$("#running_notes_form").submit( function(e) {
    e.preventDefault();
    var text = document.getElementById('new_note_text').value
    if (text) {
      $.ajax({
        async: false,
        type: 'POST',
        url: '/api/v1/running_notes/{{ project }}',
        dataType: 'json',
        data: {"note": text},
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          alert('There was an error inserting the Running Note, please try it again.');
        }
      });
      load_running_notes()
    }
    else {
      alert("The running note text cannot be empty. Please fill in the Running Note.")
    }
});

function load_undefined_info(){
  $.getJSON("/api/v1/projects_fields?undefined=true", function(data) {
    var columns_html ="";
    $.each(data, function(column_no, column) {
      columns_html += '<tr><td>' + column + '</td><td name="' + column + '"></td></tr>'
    });
    $("#undefined_project_info").html(columns_html)
    });
}

function load_all_udfs(){
  $.getJSON("/api/v1/project_summary/{{ project }}", function (data) {
    $.each(data, function(key, value) {
      //Set the project name and status
      if (prettify(key) == 'project_name'){
      	if (!data['portal_id']) {
		    project_title = "{{ project }}, " + data['project_name'] + " (no order in NGI portal)"; 
      	} else {
		    project_title = "{{ project }}, " + data['project_name'] + " (<a href='https://portal.scilifelab.se/genomics/node/" + data['portal_id'] + "'>" + data['customer_project_reference'] + "</a>)"; 
      	}
        $("[name=" + prettify(key) + "]").html(project_title);
        $("[name=" + prettify(key) + "]").attr('p_name', data['project_name']);
        //Decide project status (and color) based on the project dates
        var open_date=data["{{ columns['BASIC_COLUMNS']['Open Date'] }}"];
        var queue_date=data["{{ columns['BASIC_COLUMNS']['Queue Date'] }}"];
        var close_date=data["{{ columns['DETAILS_COLUMNS']['Close Date'] }}"];
        var aborted=data["{{ columns['DETAILS_COLUMNS']['Aborted'] }}"]
        var source=data["{{ columns['BIOINFO_COLUMNS']['Source'] }}"]
        if (aborted){
            $("[name=project_status]").text("Aborted");
            $("[name=project_status]").addClass("alert alert-error");
        }
        else {
          if (!open_date && source == 'lims'){
            $("[name=project_status]").text("Pending");
            $("[name=project_status]").addClass("alert alert-info");
          }
          else if (open_date && !queue_date) {
            $("[name=project_status]").text("Reception Control");
            $("[name=project_status]").addClass("alert alert-block");
          }
          else if (queue_date && !close_date) {
            $("[name=project_status]").text("Ongoing");
            $("[name=project_status]").addClass("alert alert-info");
          }
          else {
            $("[name=project_status]").text("Closed");
            $("[name=project_status]").addClass("alert alert-success");
          }
        }
      }
      else {
        $("[name='" + key + "']").text(value)
      }
    });
    var t = $("#tab_communication");
    t.show();
  });
};

function prettify(s) {
  s2 = s.replace("(", "_").replace(")", "_")
    return s2
}

function load_table_head(columns){
  var tbl_head = '<tr>'
    $.each(columns, function(i, column_tuple) {
        tbl_head += '<th class="sort a" data-sort="' + column_tuple[1] + '">' + column_tuple[0] + '</th>'
        });
  tbl_head += '</tr>'
    $("#samples_table_head").html(tbl_head)
}

function load_samples_table() {
  load_table_head(read_current_filtering());
  $.getJSON("/api/v1/project/{{ project }}", function (samples_data) {
    columns = read_current_filtering(true);
    var tbl_body = "";
    var size = 0;
    $.each(samples_data, function (sample, info) {
      size++;
      tbl_row = '<tr>';
      $.each(columns, function(subset, fields){
        if (subset == "basic-columns") {
          $.each(fields, function(idx, column_tuple) {
            var column_name = column_tuple[0];
            var column_id = column_tuple[1];
            // Scilife Sample Name is a link
            if (column_id == "scilife_name") {
              tbl_row += '<td><a class="' + column_id + '" href="/samples/' + 
                  info[column_id] + '">' + info[column_id] + '</a></td>';
            }
            // Sample run metrics is an array of links
            else if (column_id == 'sample_run_metrics') {
              tbl_row += '<td class="' + column_id + '">';
              for (var i=0; i<info[column_id].length; i++) {
                tbl_row += '<a href="/qc/' + info[column_id][i] + '">' + 
                  info[column_id][i] + '</br></a>';
              }
              tbl_row += '</td>';
            }
            //Library prep is an array of Objects
            else if (column_id == 'library_prep') {
              tbl_row += '<td class="' + column_id + '">';
                if ('library_prep' in info) {
                $.each(info[column_id], function(prep, info_prep){
                  tbl_row += prep + '</ br>';
                });
              }
              tbl_row += '</td>';
            }
            //Prep status and prep finished date are arrays
            else if (column_id == 'prep_status' || column_id == 'prep_finished_date') {
              tbl_row += '<td class="' + column_id + '">';
              for (var i=0; i<info[column_id].length; i++) {
                tbl_row += info[column_id][i] + '</ br>';
              }
              tbl_row += '</td>';
            }
            else {
                tbl_row += '<td class="' + column_id + '">' + info[column_id] + '</td>';
            }
          });
        }
        else if (subset == "initial-qc-columns" && info.hasOwnProperty('initial_qc')) {
          $.each(fields, function(idx, column_tuple){
            var column_name = column_tuple[0];
            var column_id = column_tuple[1];
            tbl_row += '<td class="' + column_id + '">' + info['initial_qc'][column_id] + '</td>';
          });
        }
        else if (subset == "library-prep-columns" && info.hasOwnProperty('library_prep')) {
          $.each(info['library_prep'], function(library, info_library) {
            $.each(fields, function(idx, column_tuple){
              var column_name = column_tuple[0];
              var column_id = column_tuple[1];
              tbl_row += '<td class="' + column_id + '">' + info_library[column_id] + '</td>';
            });
          });
        }
        // Details columns
        else {
          $.each(fields, function(idx, column_tuple){
            var column_name = column_tuple[0];
            var column_id = column_tuple[1];
            tbl_row += '<td class="' + column_id + '">' + info['details'][column_id] + '</td>';
          });
        }
      });
      tbl_row += '</tr>';
      tbl_body += tbl_row;
    });
    $("#samples_table_body").html(tbl_body);
    columns = read_current_filtering(false);
    init_listjs(size, columns)
  });
}

var fetching_data;
fetching_data = fetching_data || (function () {
  var pleaseWaitDiv = $(' \
    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true"> \
      <div class="modal-dialog modal-sm"> \
        <div class="modal-content"> \
          <h3>Fetching data from ZenDesk...</h3> \
          <div class="progress progress-striped active"> \
            <div class="bar" style="width: 100%"> \
              <span class="sr-only"> \
              </span> \
            </div> \
          </div> \
        </div> \
      </div> \
    </div>');
  return {
    showPleaseWait: function() {
      pleaseWaitDiv.modal();
    },
      hidePleaseWait: function () {
        pleaseWaitDiv.modal('hide');
      },
  };
})();

</script>

{% end %}
