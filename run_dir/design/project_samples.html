{% extends "base.html" %}

<!-- Example row of columns -->
{% block stuff %}

<div class="row-fluid">
  <h3 name="project_name"></h3>
  <div name="project_status"> </div>
    <!--Order dates table -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Order Received</th>
          <th>Contract Sent</th>
          <th>Plates Sent</th>
          <th>Contract Received</th>
          <th>Sample Information Received</th>
          <th>Samples Received</th>
        </tr>
      </thead>
      <tbody>
      <tr>
        <td name='{{columns['SETUP_PROJECT_COLUMNS']['Order Received']}}'></td>
        <td name='{{columns['SETUP_PROJECT_COLUMNS']['Contract Sent']}}'></td>
        <td name='{{columns['SETUP_PROJECT_COLUMNS']['Plates Sent']}}'></td>
        <td name='{{columns['SETUP_PROJECT_COLUMNS']['Contract Received']}}'></td>
        <td name='{{columns['SETUP_PROJECT_COLUMNS']['Sample Information Received']}}'></td>
        <td name='{{columns['SETUP_PROJECT_COLUMNS']['Samples Received']}}'></td>
      </tr>
      </tbody>
    </table>
    <!-- Protect timeline -->
    <table class="table table-bordered table-condensed">
      <thead>
        <tr>
          <th>Days in Production</th>
          <th>Open date</th>
          <th>First Initial QC Start Date</th>
          <th>Queue Date</th>
          <th>Library Prep Start</th>
          <th>QC Library Finished</th>
          <th>Sequencing Start</th>
          <th>All Samples Sequenced</th>
          <th>All Raw Data Delivered</th>
          <th>Best Practice Analysis Completed</th>
          <th>Close Date</th>
        </tr>
      </thead>
      <tbody>
      <tr>
        <td name='{{columns['BASIC_COLUMNS']['Days in Production']}}'></td>
        <td name='{{columns['BASIC_COLUMNS']['Open Date']}}'></td>
        <td name='{{columns['EXTRA_COLUMNS']['First Initial QC Start Date']}}'></td>
        <td name='{{columns['BASIC_COLUMNS']['Queue Date']}}'></td>
        <td name='{{columns['LIBRARY_PREP_COLUMNS']['Library Prep Start']}}'></td>
        <td name='{{columns['LIBRARY_PREP_COLUMNS']['QC Library Finished']}}'></td>
        <td name='{{columns['SEQUENCING_COLUMNS']['Sequencing Start']}}'></td>
        <td name='{{columns['DETAILS_COLUMNS']['All Samples Sequenced']}}'></td>
        <td name='{{columns['BIOINFO_COLUMNS']['All Raw Data Delivered']}}'></td>
        <td name='{{columns['BIOINFO_COLUMNS']['Best Practice Analysis Completed']}}'></td>
        <td name='{{columns['DETAILS_COLUMNS']['Close Date']}}'></td>
      </tr>
      </tbody>
    </table>
    
</div>

<div class="accordion" id="accordion">
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" href="#collapseOne">
        Project details
      </a>
    </div>
    <div id="collapseOne" class="accordion-body collapse">
      <div class="accordion-inner">
        <div class="row-fluid">
          <div class="span12">
            <div class="span4">
              <!--Order Info Table-->
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Order info</th>
                  </tr>
                </thead>
                <tbody>
                <tr>
                  <td>Uppnex ID</td>
                  <td name='{{columns['BIOINFO_COLUMNS']['Uppnex ID']}}'></td>
                </tr>
                <tr>
                  <td>Type</td>
                  <td name='{{columns['BASIC_COLUMNS']['Type']}}'></td>
                </tr>
                <tr>
                  <td>Application</td>
                  <td name='{{columns['BASIC_COLUMNS']['Application']}}'>Application</td>
                </tr>
                <tr>
                  <td>Best Practice Bioinformatics</td>
                  <td name='{{columns['BIOINFO_COLUMNS']['Best Practice Bioinformatics']}}'></td>
                </tr>
                <tr>
                  <td>Bioinfo Analysis</td>
                  <td name='{{columns['BIOINFO_COLUMNS']['Bioinformatic QC']}}'></td>
                </tr>
                <tr>
                  <td>Reference Genome</td>
                  <td name='{{columns['BIOINFO_COLUMNS']['Reference Genome']}}'></td>
                </tr>
                <tr>
                  <td>Sequencing Setup</td>
                  <td name='{{columns['SEQUENCING_COLUMNS']['Sequencing Setup']}}'></td>
                </tr>
                </tbody>
              </table>
            </div>
            <div class="span4">
              <!--Sample Info Table-->
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Sample Info</th>
                  </tr>
                </thead>
                <tbody>
                <tr>
                  <td>Nr. Samples</td>
                  <td name='{{columns['BASIC_COLUMNS']['Number of Samples']}}'></td>
                </tr>
                <tr>
                  <td>Nr. Samples passed library QC</td>
                  <td name='{{columns['BASIC_COLUMNS']['Passed Samples']}}'></td>
                </tr>
                <tr>
                  <td>Total Nr. Samples</td>
                  <td name='{{columns['DETAILS_COLUMNS']['Final Number of Samples']}}'></td>
                </tr>
                </tbody>
              </table>
            </div>
            <div class="span4">
              <!-- Responsable and Contacts table -->
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Responsible</th>
                  </tr>
                </thead>
                <tbody>
                <tr>
                  <td>Bioinfo</td>
                  <td>what_to_put_here??</td>
                </tr>
                <tr>
                  <td>Lab</td>
                  <td>what_to_put_here??</td>
                </tr>
                </tbody>
              </table>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Contacts</th>
                  </tr>
                </thead>
                <tbody>
                <tr>
                  <td>PI</td>
                  <td>what_to_put_here??</td>
                </tr>
                </tbody>
              </table>
            </div>
            <!-- Undefined fields -->
            <div class="span11">
              <div class="accordion" id="accordion2">
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#collapseUndefinedFields">
                      Undefined Fields
                    </a>
                  </div>
                  <div id="collapseUndefinedFields" class="accordion-body collapse">
                    <div class="accordion-inner">
                      <!-- Undefined Fields Table -->
                      <table class="table table-condensed table-hover">
                        <tbody id="undefined_project_info">
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- -->
            <div class="span11">
              <p>
              Note that for some projects the ordered number of reads per sample is on a
              per sample basis. At this moment that information is then impossible to
              parse. In the future when the LIMS is being used that information will be
              available on per sample level.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" href="#collapseThree">
        Project Samples
      </a>
    </div>
    <div id="collapseThree" class="accordion-body collapse">
      <div class="accordion-inner">
        <p>
        This lists all samples belonging to the project. Here 'reads sequenced'
        refers to reads passing application QC criterions. If the sequence run is
        paired end, 'reads' are actually read pairs.
        </p>
        <p>
        If a sample is named 'Unexptectedbarcode' refers to reads which failed to
        demultiplex.
        </p>
        <table class="table table-striped" id="sample_table">
          <thead>
            <tr>
              <th>SciLife Sample Name</th>
              <th>Customer Name</th>
              <th>Sample runs</th>
              <th>Incoming QC Status</th>
              <th>Library preps</th>
              <th>Library QC</th>
              <th>Library QC Date</th>
              <th>Million reads sequenced</th>
              <th>Sequencing QC</th>
              <th>Status Manual</th>
              <th>Reads Minimum</th>
              <th>Reads Requested</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Javascript -->

<script>
var ordered_reads = 0.0

load_undefined_info()
load_all_udfs()

  function load_undefined_info(){
    $.getJSON("/api/v1/projects_fields?undefined=true", function(data) {
        var columns_html ="";
        $.each(data, function(column_no, column) {
          columns_html += '<tr><td>' + column + '</td><td name=' + prettify(column) + '></td></tr>'
        });
        $("#undefined_project_info").html(columns_html)
        });
  }

function load_all_udfs(){
  $.getJSON("/api/v1/project_summary/{{ project }}", function (data) {
    $.each(data, function(key, value) {
      if (prettify(key) == 'project_name'){
        $("[name=" + prettify(key) + "]").text(value);
        //Decide project status (and color) based on the project dates
        var open_date=data["{{ columns['BASIC_COLUMNS']['Open Date'] }}"];
        var queue_date=data["{{ columns['BASIC_COLUMNS']['Queue Date'] }}"];
        var close_date=data["{{ columns['DETAILS_COLUMNS']['Close Date'] }}"];
        if (!open_date){
          $("[name=project_status]").text("Pending");
          $("[name=project_status]").addClass("alert alert-info");
        }
        else if (open_date && !queue_date) {
          $("[name=project_status]").text("Reception Control");
          $("[name=project_status]").addClass("alert alert-block");
        }
        else if (queue_date && !close_date) {
          $("[name=project_status]").text("Ongoing");
          $("[name=project_status]").addClass("alert alert-info");
        }
        else if (close_date) {
          $("[name=project_status]").text("Closed");
          $("[name=project_status]").addClass("alert alert-success");
        }
      }
      else {
        $("[name=" + prettify(key) + "]").text(value)
      }
    });
  });
};

function prettify(s) {
  s2 = s.replace("(", "_").replace(")", "_")
    return s2
}

$.getJSON("/api/v1/projects/{{ project }}", function (data) {
    $.each(data, function (sample, info) {
      var details = info["details"];
      tbl_row = "<tr>"
      tbl_row += '<td><a href="/samples/' + sample + '">' + sample + '</td>'
      tbl_row += '<td>' + info['customer_name'] + '</td>'
      tbl_row += '<td>'      
      $.each(info["sample_run_metrics"], function(ix, run) {
        tbl_row += '<a href="/qc/' + run + '">' + run + '</a><br>'
      })
      tbl_row += '</td>'
      if ('passed_initial_qc' in info) {
        tbl_row += '<td>' + info["passed_initial_qc"] + '</td>'
      }
      else {
        tbl_row += '<td>' + info["incoming_QC_status"] + '</td>'
      }
      tbl_row += '<td>'
        if (info["library_prep"]) {
          $.each(info["library_prep"], function(lib_prep, content) {
            tbl_row += lib_prep + '<br>'
          })
       }
      tbl_row += '</td>'
      tbl_row += '<td>'
      $.each(info["prep_status"], function(ix, prep_status) {
          tbl_row += prep_status + '<br>'
      })
      tbl_row += '</td>'

      tbl_row += '<td>'
      $.each(info["prep_finished_date"], function(ix, prep_date) {
        tbl_row += prep_date + '<br>'
      })
      tbl_row += '</td>'
        
      m_reads_sequenced = parseFloat(info["m_reads_sequenced"])
      tbl_row += '<td>' + m_reads_sequenced.toFixed(2) + '</td>'

      /* Sequencing QC */
      tbl_row += '<td>' + info["status"] + '</td>'

      /* Status */
      if ('details' in info) {
        tbl_row += '<td>' + info["details"]["status_(manual)"] + '</td>'
      }
      else {
        tbl_row += '<td>' + "Undefined" + '</td>'
      }

      tbl_row += '<td>' + info["reads_min"] + '</td>'
      tbl_row += '<td>' + info["reads_req"] + '</td>'

      tbl_row += "</tr>"
      $("#sample_table tbody").append(tbl_row)
    });
});

</script>

{% end %}
