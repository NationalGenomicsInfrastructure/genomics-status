{% extends "base.html" %}

<!-- Example row of columns -->
{% block stuff %}

<div class="container-fluid" id="sample_list">
  <h2>{{ project }}</h2>
  <h3 name="project_name"></h3><br>
  <div id="project_info">
    <div class="row-fluid">
      <div class="span12">
	<div class="span6">
	  <h3> Project Details </h3>
	  <dl class="dl" id="project_info_details">
	    {% for col_display_name, col_name in columns['DETAILS_COLUMNS'].iteritems() %}
	    <dt>{{ col_display_name }}</dt><dd name={{prettify(col_name)}}></dd>
	    {% end %}
	  </dl>
	</div>
      </div>
      <div class="span12">
	<div class="span3">
	  <h3> Basic Information </h3>
	  <dl class="dl" id="project_info_default">
	    {% for col_display_name, col_name in columns['DEFAULT_COLUMNS'].iteritems() %}
	    <dt>{{ col_display_name }}</dt><dd name={{prettify(col_name)}}></dd>
	    {% end %}
	  </dl>
	  <h3> Bioinformatics </h3>
	  <dl class="dl" id="project_info_bioinfo">
	    {% for col_display_name, col_name in columns['BIOINFO_COLUMNS'].iteritems() %}
	    <dt>{{ col_display_name }}</dt><dd name={{prettify(col_name)}}></dd>
	    {% end %}
	  </dl>
	</div>
	<div class="span3">
	  <h3> Defined Extra </h3>
	  <dl class="dl" id="project_info_extra">
	    {% for col_display_name, col_name in columns['EXTRA_COLUMNS'].iteritems() %}
	    <dt>{{ col_display_name }}</dt><dd name={{prettify(col_name)}}></dd>
	    {% end %}
	  </dl>
	</div>
	<div class="span6" id="undefined_project_info">
	  <h3> Undefined Extra </h3>
	  <dl class="dl">
	  </dl>
	</div>
      </div>
    </div>
  </div>
  <p>
    Note that for some projects the ordered number of reads per sample is on a
    per sample basis. At this moment that information is then impossible to
    parse. In the future when the LIMS is being used that information will be
    available on per sample level.
  </p>
  <h3>Samples</h3>
  <p>
    
    This lists all samples belonging to the project. Here 'reads sequenced'
    refers to reads passing application QC criterions. If the sequence run is
    paired end, 'reads' are actually read pairs.
    
  </p>
  <p>
    If a sample is named 'Unexptectedbarcode' refers to reads which failed to
    demultiplex.
  </p>
  <table class="table table-striped" id="sample_table">
    <thead>
      <tr>
        <th>SciLife Sample Name</th>
	<th>Customer Name</th>
        <th>Sample runs</th>
        <th>Library preps</th>
	<th>Library QC</th>
	<th>Library QC Date</th>
        <th>Million reads sequenced</th>
        <th>Incoming QC Status</th>
        <th>Sequencing QC</th>
	<th>Status Manual</th>
      </tr>
    </thead>
    <tbody></tbody>
    
  </table>
</div>

<script>
var ordered_reads = 0.0

load_undefined_info()
load_all_udfs()

function load_undefined_info(){
  $.getJSON("/api/v1/projects_fields?undefined=true", function(data) {
    var columns_html ="";
    $.each(data, function(column_no, column) {
      columns_html += '<dt>' + column + '</dt><dd name=' + prettify(column) + '></dd>'
    });
    $("#undefined_project_info dl").html(columns_html)
  });
}

function load_all_udfs(){
  $.getJSON("/api/v1/project_summary/{{ project }}", function (data) {
    $.each(data, function(key, value) {
      $("[name=" + prettify(key) + "]").text(value)
    });
  });
};

function prettify(s) {
  s2 = s.replace("(", "_").replace(")", "_")
  return s2
}

$.getJSON("/api/v1/projects/{{ project }}", function (data) {
  $.each(data, function (sample, info) {
    tbl_row = "<tr>"

    tbl_row += '<td><a href="/samples/' + sample + '">' + sample + '</td>'

    tbl_row += '<td>' + info['customer_name'] + '</td>'
    tbl_row += '<td>'
    if (info["library_prep"]) {
      $.each(info["library_prep"], function(lib_prep, content) {
        if (content["sample_run_metrics"]) {
          $.each(content["sample_run_metrics"], function (run, id) {
            tbl_row += '<a href="/qc/' + run + '">' + run + '</a><br>'
          })
        }
      })
    }
    tbl_row += '</td>'

    tbl_row += '<td>'
    if (info["library_prep"]) {
      $.each(info["library_prep"], function(lib_prep, content) {
        tbl_row += lib_prep + '<br>'
      })
    }
    tbl_row += '</td>'

    tbl_row += '<td>'
    if (info["library_prep"]) {
      $.each(info["library_prep"], function(lib_prep, content) {
        if (content["prep_status"] == "PASSED") {
          tbl_row += "P" + '<br>'
        } 
        else {
          tbl_row += "F" + '<br>'
        }
      });
    }
    tbl_row += '</td>'
    tbl_row += '<td>'
    if (info["library_prep"]) {
      $.each(info["library_prep"], function(lib_prep, content) {
        tbl_row +=  content["prep_finished_date"] + '<br>'
      });
    }
    tbl_row += '</td>'

    m_reads_sequenced = parseFloat(info["m_reads_sequenced"])

    tbl_row += '<td>' + m_reads_sequenced.toFixed(2)

    tbl_row += '</td>'

    if ('details' in info) {
      passed = info["details"]["passed_initial_qc"] 
      tbl_row += '<td>'
      if (passed == "True"){
        tbl_row += "P"
      }
      else {
        tbl_row += "F"
      }
      tbl_row += '</td>'
    } 
    else { 
      tbl_row += '<td>' + info["incoming_QC_status"] + '</td>'
    }
    /* Sequencing QC */
    tbl_row += '<td>' + info["status"] + '</td>'

    /* Status */
    tbl_row += '<td>' + info["details"]["status_(manual)"] + '</td>'
    tbl_row += "</tr>"
    $("#sample_table tbody").append(tbl_row)
  });
});

</script>

{% end %}
