{% extends "base_new.html" %}

<!-- 
Template file: quota_grid.html
URL: /quotas
Title: Historical UPPMAX storage quota for all UPPMAX projects
Description: Shows a grid of graphs showing showing storage information
             for all UPPMAX projects

TODO: Seems to only display graphs sporadically, after a very long time.
TODO: When graphs do show, the plots seem wrong.
-->

{% block stuff %}

<h2>Historical storage quota used on UPPMAX projects</h2>

<div id="plots"></div>


<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    
    // Find the differe UPPMAX Projects
    $.getJSON('/api/v1/uppmax_projects', function(uppmax_quotas) {
        $.each(uppmax_quotas, function(i, up) {
            $("#plots").append('\
            <div id="container_'+up+'" style="float:left; width: 49%; height:400px;"> \
                <h2><a href="/quotas/'+up+'">'+up+'</a></h2> \
                <p id="loading_spinner_'+up+'"><span class="glyphicon glyphicon-refresh glyphicon-spin"></span>  Loading plot.. <em>(can take some time)</em></p> \
                <div id="chart_'+up+'"></div> \
            </div>');
    
            // Load the data for this project
            $.getJSON('/api/v1/quotas/'+up, function(api_data) {
        
                // Massage the data
                var raw_data = api_data[0]["data"];
                var plot_data = [];
                $.each(raw_data, function(i, d){
                    plot_data.push([d.x * 1000, d.y / 1000000000000]);
                });
        
                // Plot the data
                $('#chart_'+up).highcharts({
                    chart: { type: 'area'},
                    title: { text: "Storage Usage Over Time: "+up },
                    legend: { enabled: false },
                    xAxis: { 
                        title: { text: 'Date' },
                        type: 'datetime'
                    },
                    yAxis: {
                        title: { text: 'Storage' },
                        labels: {
                            formatter: function () {
                                return this.value + 'Tb';
                            }
                        }
                    },
                    tooltip: {
                        pointFormat: '<strong>{series.name}</strong>: {point.y:,.2f} Tb',
                    },
                    series: [{
                        name: up,
                        data: plot_data
                    }]
                });
                
                // Hide the loading spinner
                $('#loading_spinner_'+up).hide();
                
            });
            
        });
    });
});
</script>

{% end %}
